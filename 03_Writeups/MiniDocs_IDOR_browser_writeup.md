# MiniDocs — IDOR

## 解法（ブラウザ）

### 1) ログイン（alice/testalice）
- **URL欄**：`http://127.0.0.1:8000/login`
- **画面名**：「Login」
- **操作**：`Username` に **alice**、`Password` に **testalice** を入力 → **Sign in** ボタン。
- **挙動**：成功すると **/**（Home）へ 302 リダイレクト。ナビに `home · me · docs · logout` が表示される。

### 2) ドキュメント一覧 / ヒントの観察ポイント
- **me 画面**（URL：`/me`）  
  - 画面名：「Me」。自分のメモ一覧（表ヘッダ：**ID / Title / Created**）と「New Doc」フォームがある。  
  - alice のメモに次のヒントが含まれる：  
    - **「管理者のIDについて」**… *管理者が使っているIDはシンプル（=推測しやすい）*  
    - **「パスワード管理方法の見直し」**… *管理者がパスワードをメモに保存している*  
- **docs 画面**（URL：`/docs`）  
  - 画面名：「Docs」。一般ユーザ視点では**自分のメモのみ**が一覧表示（表ヘッダ：**ID / Title / Owner / Created**）。  
  - **ID 列**のリンク形式が `/docs/<id>` であることを確認。

### 3) doc-id の推測手順（プレフィックス規則・番号範囲・リンクパターン）
- **命名規則**：`doc-<prefix>-NNNN`（4桁連番）。  
  - 既知の対応：`alice → al`、`admin → ad`、`bob → bo`
- **推測戦略**：
  1. 管理者の ID はシンプル ⇒ **admin** と仮定  
  2. 管理者の文書は **`doc-ad-xxxx`** で存在すると推測  
  3. **URL欄**で直接叩く：`/docs/doc-ad-0001`、無ければ `0002`、`0003`… とインクリメント
- **エラーハンドリング**：存在しない ID は **404 not found** のカード表示。アカウントロック等は無い。

### 4) “管理者メモ doc” への到達と、管理者パスワードの取得
- **URL欄**：`/docs/doc-ad-0003`（例）  
- **画面名**：文書タイトル「**パスワード**」  
- **本文例（抜粋）**：`パスワード: <hidden>`  
  - 管理者のパスワードが本文に記載されている（※ 実文字列は出さない）。  
- **重要**：このビューには**所有者チェックが無い**ため、alice 権限でも管理者文書が閲覧できる（IDOR）。

### 5) /admin で管理者ログイン → 管理画面から `<FLAG_IDOR>` を確認
1. 右上ナビの **logout** を押下 → `/login` へ。
2. 再ログイン：`Username=admin`、`Password=<hidden>` を入力 → **Sign in**。  
   - 成功するとナビに **admin** リンクが出現。
3. **URL欄**：`/admin` へ移動。  
   - **画面名**：「Admin」。  
   - 上部カード **「IDOR flag」** セクションに **`<FLAG_IDOR>`** が表示されている。  
   - 下部 **「現在の設定」** セクションには Diagnostics JSON が出力される。

### つまずきポイント / 代替ルート
- **404の扱い**：`/docs/doc-ad-000X` の存在しない番号は 404 表示。番号を増減して探索可能。  
- **一覧の制約**：`/docs` は一般ユーザ視点だと自分の文書のみ。**直接 URL を推測**して叩く必要がある。  
- **命名規則**：`prefix` 対応（al/ad/bo）を読み解けないと探索が拡散しやすい。

---

## 付録：curl 参考（数行）
> 先に alice でログインして Cookie を取得しておくこと。フラグやパスワードの実文字列は表示しない。

```bash
# 1) alice でログイン（Cookie 保存）
curl -s -c c.txt -d 'user=alice&pass=testalice' http://127.0.0.1:8000/login > /dev/null
# 2) 管理者メモを直接参照（所有者チェックなし → IDOR）
curl -s -b c.txt http://127.0.0.1:8000/docs/doc-ad-0003 | sed -n 's/.*パスワード: \([^<]*\).*//p'   # => <hidden>
```

---

## 根本原因と対策（IDOR）
- **原因**：`GET /docs/:id` が **所有者チェックを行わず**存在すればそのまま本文を返すため、他人（admin）の機密文書を閲覧できる。  
- **対策（最小）**：
  - ① ハンドラで `currentUser===owner`（または admin）を満たさない場合は **403** にする。  
  - ② 可能なら**DBクエリ条件に `WHERE id=? AND owner=?`** を組み込み、ハンドラに来る前にスコープを絞る（認可の一貫性）。
