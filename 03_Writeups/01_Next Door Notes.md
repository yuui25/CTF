# Next Door Notes

## 解法（簡易版）
1. 一般ユーザ `alice/testalice` でログインし、**doc-id 規則**（`doc-<prefix>-NNNN`）を把握。  
2. **管理者 prefix（ad）**の doc-id を直接 URL で試行（例：`/docs/doc-ad-0003`）し、メモ内の**管理者パスワード**を取得。  
3. `admin/<hidden>` でログインし、**管理画面**で `<FLAG_IDOR>` を確認。

## 解法（詳細）

### 1) ログイン（alice/testalice）
- **URL欄**：`http://127.0.0.1:8000/login`
- **画面名**：「Login」
- **操作**：`Username` に **alice**、`Password` に **testalice** を入力 → **Sign in** ボタン。

### 2) ヒント
- **me 画面**（URL：`/me`）  
  - 画面名：「Me」。自分のメモ一覧と「New Doc」フォームがある。  
  - alice のメモに次のヒントが含まれる：  
    - **「管理者のIDについて」**… *管理者が使っているIDはシンプル（=推測しやすい）*  
    - **「パスワード管理方法の見直し」**… *管理者がパスワードをメモに保存している*  

### 3) doc-id の推測手順
- **命名規則**：`doc-<prefix>-NNNN`（4桁連番）。  
  - 既知の対応：`alice → al`、`admin → ad`、`bob → bo`
- **推測**：
  1. 管理者の ID はシンプル ⇒ **admin** と仮定  
  2. 管理者の文書は **`doc-ad-xxxx`** で存在すると推測  
  3. **URL欄**で直接叩く：`/docs/doc-ad-0001`、無ければ `0002`、`0003`… とインクリメント

### 4) “管理者メモ doc” への到達と、管理者パスワードの取得
- **URL欄**：`/docs/doc-ad-0003`  
- **画面名**：文書タイトル「**パスワード**」  
- **本文例（抜粋）**：`パスワード: <hidden>`  
  - 管理者のパスワードが本文に記載されている。  
- **重要**：このビューには**所有者チェックが無い**ため、alice 権限でも管理者文書が閲覧できる（IDOR）。

### 5) /admin で管理者ログイン → 管理画面から `<FLAG_IDOR>` を確認
1. 右上ナビの **logout** を押下 → `/login` へ。
2. 再ログイン：`Username=admin`、`Password=<hidden>` を入力 → **Sign in**。  
   - 成功するとナビに **admin** リンクが出現。
3. 右上からadmin移動。  
   - **「IDOR flag」** セクションに **`<FLAG_IDOR>`** が表示されている。  

### つまずきポイント
- **404の扱い**：`/docs/doc-ad-000X` の存在しない番号は 404 表示。番号を増減して探索可能。  
- **一覧の制約**：`/docs` は一般ユーザ視点だと自分の文書のみ。**直接 URL を推測**して叩く必要がある。  
- **命名規則**：`prefix` 対応（al/ad/bo）を読み解けないと探索が拡散しやすい。

---

## 付録：curl 参考（数行）
> 先に alice でログインして Cookie を取得しておくこと。フラグやパスワードの実文字列は表示しない。

```bash
# 1) alice でログイン（Cookie 保存）
curl -s -c c.txt -d 'user=alice&pass=testalice' http://127.0.0.1:8000/login > /dev/null
# 2) 管理者メモを直接参照（所有者チェックなし → IDOR）
curl -s -b c.txt http://127.0.0.1:8000/docs/doc-ad-0003 | sed -n 's/.*パスワード: \([^<]*\).*//p'   # => <hidden>
```

---

## 根本原因と対策（IDOR）
- **原因**：`GET /docs/:id` が **所有者チェックを行わず**存在すればそのまま本文を返すため、他人（admin）の機密文書を閲覧できる。  
- **対策（最小）**：
  - ① ハンドラで `currentUser===owner`（または admin）を満たさない場合は **403** にする。  
  - ② 可能なら**DBクエリ条件に `WHERE id=? AND owner=?`** を組み込み、ハンドラに来る前にスコープを絞る（認可の一貫性）。
